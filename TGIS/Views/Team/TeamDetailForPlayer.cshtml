@using TGIS.Models
@model Team

@{
    ViewBag.Title = "TeamDetailForPlayer";
    Layout = "~/Views/Shared/_LayoutPlayer.cshtml";
}

<h2>@Html.DisplayFor(model => model.Title)</h2>

<div>
    <hr />
    <dl class="dl-horizontal">

        <dt>
            @Html.DisplayNameFor(model => model.ParticipateEndDate)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.ParticipateEndDate)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Notes)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Notes)
        </dd>


        <dt>
            遊戲時間
        </dt>

        <dd>
            @Html.DisplayFor(model => model.PlayDate)<br />
            @Model.PlayBeginTime.ToString(@"hh\:mm") 至 @Model.PlayEndTime.ToString(@"hh\:mm")
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.EstimatedCost)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.EstimatedCost)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Preference)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Preference)
        </dd>

        <dt>
            人數
        </dt>

        <dd>
            @Html.DisplayFor(model => model.MinPlayer) 至 @Html.DisplayFor(model => model.MaxPlayer) 人
        </dd>



        <dt>
            發起人暱稱
        </dt>

        <dd>
            @Html.DisplayFor(model => model.LeaderPlayer.NickName)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Shop.ShopName)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Shop.ShopName)
        </dd>

        <dt>
            狀態
        </dt>

        <dd>
            @{
                string status = "";
                bool isOpen = false;
                bool isExpiredOrCanceled = false;
                int nowPlayers = Model.OtherPlayers.Count + 1;
                if (Model.IsCanceled) { status = "已取消出團"; isExpiredOrCanceled = true; }
                else if (Model.IsClosed) { status = "已提前截止報名"; isExpiredOrCanceled = true; }
                else if (DateTime.Now > Model.PlayDate) { status = "已過期"; isExpiredOrCanceled = true; }
                else if (DateTime.Now > Model.ParticipateEndDate) { status = "報名時間已過"; }
                else if (nowPlayers >= Model.MaxPlayer) { status = "已額滿，僅開放報名候補"; }
                else if (nowPlayers < Model.MinPlayer) { status = $"可報名，未達成團人數(目前：{nowPlayers} / 最低：{Model.MinPlayer})"; isOpen = true; }
                else { status = $"可報名，已達成團人數(目前：{nowPlayers})"; isOpen = true; }
            }
            @status
        </dd>
    </dl>
</div>
@* 
    狀態對應性：
                        隊長                   隊員          非隊員玩家           未登入會員

    可報名        提早收團           退出            參加                      登入
                        解散                  
    
    已收團         解散                  退出?              xxx                    登入

    已過期         xxx                     xxx             xxxx                      登入                   (根本不該顯示，僅作為紀錄)
    已解散

*@


@{
    //判斷進入此頁面的玩家是否為隊長或其他玩家
    bool isLeader = Model.LeaderPlayerID == (string)Session["playerID"];
    bool isInTeam = Model.OtherPlayers.Any(m => m.ID == (string)Session["playerID"]);
    string btnInfo = "";
    string action = "";
    string disabled = "";
    //尚未登入
    if (Session["PlayerID"] == null)
    {
        @Html.ActionLink("登入", "LoginForPlayer", "Login", null, new { @class = "btn btn-primary" })
    }
    //已過期或已解散
    else if (isExpiredOrCanceled) 
    { 
        //什麼按鈕都沒有
    }
    else
    {
        if (isLeader)
        {
            btnInfo = "解散";
            action = "cancel";
        }
        else if (isInTeam)
        {
            btnInfo = "退出";
            action = "exit";
        }
        else
        {
            //若已經收團，則讓功能鈕失效
            disabled = isOpen ? "" : "disabled";
            btnInfo = "參加";
            action = "join";
        }
        using (Html.BeginForm())
        {
            <input type="hidden" name="teamID" value="@Model.ID" />
            <input type="hidden" name="action" id="action" value="@action" />
            <input type="hidden" name="playerID" value="@Session["PlayerID"]" />
            <button class="btn btn-primary" type="submit" @disabled>@btnInfo</button>
            if (isLeader && isOpen)
            {
                <button class="btn btn-secondary" type="submit" onclick="$('#action').val('close')">提前截止</button>
            }
        }
    }

}
<p>
    @Html.ActionLink("回到列表", "TeamIndexForPlayer")
</p>


@*
    參團功能：
    -- 使用者來到桌遊詳細頁面，從session取得其ID
    -- 若此桌並非由此使用者發起且狀態正常(無過期、取消、提早截止)則可以參加或退出
    -- 點擊「參加」，將此使用者加入此團的揪桌人員明細
    -- 點擊「退出」，將此使用者從此團的揪桌人員明細移除
    -- 不論點擊哪個鈕都會重新整理頁面(也就是會發送表單)
*@